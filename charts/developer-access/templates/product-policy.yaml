{{/*
  APIM ProductPolicy - Rate limiting and quota enforcement
  Uses rate-limit-by-key for per-minute limits and quota-by-key for quotas
*/}}
apiVersion: apimanagement.azure.com/v1api20220801
kind: ProductPolicy
metadata:
  name: {{ printf "%s-policy" (include "developer-access.productName" .) | quote }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "developer-access.labels" . | nindent 4 }}
spec:
  azureName: policy
  owner:
    name: {{ include "developer-access.productName" . | quote }}
  format: xml
  value: |
    <policies>
      <inbound>
        <base />
        <!-- Rate limiting per minute -->
        <rate-limit-by-key
          calls="{{ .Values.limits.callsPerMinute | default 100 }}"
          renewal-period="60"
          counter-key="@(context.Subscription.Id)" />
        <!-- Daily quota -->
        <quota-by-key
          calls="{{ .Values.limits.dailyQuota | default 10000 }}"
          renewal-period="{{ .Values.limits.renewalPeriod }}"
          counter-key="@(context.Subscription.Id)" />
      </inbound>
      <backend>
        <base />
      </backend>
      <outbound>
        <base />
      </outbound>
      <on-error>
        <base />
      </on-error>
    </policies>
